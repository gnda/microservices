version: "3.8"
services:

# Adminer to manage databases

  adminer:
    image: adminer:latest
    ports:
      - 8080:8080
    networks:
      - db

# Front microservice

  web_back:
    build:
      context:  ./docker/front/
      dockerfile: Dockerfile.node
    entrypoint:
      sh -c "ln -sf /install/node_modules node_modules &&
      ln -sf /install/package.json package.json &&
      ln -sf /install/package-lock.json package-lock.json &&
      ng serve --host 0.0.0.0 --port 5000 --disableHostCheck"
    tty: true
    volumes:
      - ./volumes/front:/usr/src/app
    working_dir: /usr/src/app
    networks:
      - web
      - inventory

  web_proxy:
    build:
      context:  ./docker/front/
      dockerfile: Dockerfile.nginx
    depends_on:
      - web_back
    volumes:
      - /etc/localtime:/etc/localtime:ro
    ports:
      - 80:80
      - 443:443
    networks:
      - web
      - inventory
      - authentication

# Authentication microservice

  authentication_back:
    build:
      context: ./docker/back/
      dockerfile: Dockerfile.python
    depends_on:
      - authentication_db
    entrypoint: "python -m flask run --host=0.0.0.0 --port=8000"
    volumes:
      - ${PWD}/volumes/back/authentication:/opt/app
      - /etc/localtime:/etc/localtime:ro
    working_dir: /opt/app
    networks:
      - authentication

  authentication_db:
    image: mysql:8
    environment:
      MYSQL_DATABASE: ${AUTHENTICATION_DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - ${PWD}/volumes/db/authentication_data:/var/lib/mysql
      - /etc/localtime:/etc/localtime:ro
    networks:
      - db
      - authentication

# Inventory microservice

  inventory_back:
    build:
      context: ./docker/back/
      dockerfile: Dockerfile.python
    depends_on:
      - inventory_db
    entrypoint: "python -m flask run --host=0.0.0.0 --port=8000"
    volumes:
      - ${PWD}/volumes/back/inventory:/opt/app
      - /etc/localtime:/etc/localtime:ro
    working_dir: /opt/app
    networks:
      - inventory

  inventory_db:
    image: mysql:8
    environment:
      MYSQL_DATABASE: ${INVENTORY_DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - ${PWD}/volumes/db/inventory_data:/var/lib/mysql
      - /etc/localtime:/etc/localtime:ro
    networks:
      - db
      - inventory

networks:
  db:
    name: db
  authentication:
    name: authentication
  inventory:
    name: inventory
  web:
    name: web